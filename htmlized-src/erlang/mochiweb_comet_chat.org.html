<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.34 in css mode. -->
<html>
  <head>
    <title>mochiweb_comet_chat.org</title>
    <style type="text/css">
    <!--
      body {
        color: #F8F8F8;
        background-color: #0C1021;
      }
      .comment {
        /* font-lock-comment-face */
        color: #AEAEAE;
        font-style: italic;
      }
      .org-block {
        /* org-block */
        color: #b3b3b3;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #AEAEAE;
        font-style: italic;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #AEAEAE;
        font-style: italic;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-size: 144%;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #FF6400;
      }
      .org-link {
        /* org-link */
        color: #00ffff;
        text-decoration: underline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #AEAEAE;
        font-style: italic;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-document-info-keyword">#+TITLE:</span><span class="comment"> </span><span class="org-document-title">&#32593;&#19978;&#21363;&#26102;&#32842;&#22825;&#21407;&#29702;(mochiweb+jquery&#23454;&#29616;)</span>
<span class="org-meta-line">#+FILETAGS: @Erlang
</span><span class="org-level-1">* &#20195;&#30721; &#20301;&#32622;</span>
  <span class="org-link">https://github.com/jixiuf/helloerlang/tree/master/mochiweb_comet_chat</span>
<span class="org-level-1">* &#25805;&#20316;:</span>
  &#20998;&#21035;&#25171;&#24320;&#20004;&#20010;&#32593;&#39029;&#65292;&#28982;&#21518;&#65292;&#23545;textfield&#20013;&#36755;&#20837;&#20869;&#23481;&#65292;&#22312;&#21478;&#19968;&#20010;&#32593;&#39029;&#20013;&#20250;&#21363;&#26102;&#26174;&#29616;.
<span class="org-level-1">* Comet</span>
Comet &#26159;&#19968;&#39033;&#24456;&#26102;&#39654;&#30340;&#25216;&#26415;&#12290;&#20854;&#30446;&#30340;&#24456;&#31616;&#21333;&#65306;&#30001;&#20110;&#21382;&#21490;&#21407;&#22240;&#65292;&#30446;&#21069; HTTP &#21327;&#35758;&#20449;&#24687;&#37117;&#26159;&#23458;
&#25143;&#31471;&#21521;&#26381;&#21153;&#22120;&#35201;&#65288;Poll&#65289;&#65292;&#26381;&#21153;&#22120;&#27809;&#26377;&#21150;&#27861;&#25512;&#36865;&#20449;&#24687;&#32473;&#23458;&#25143;&#31471;&#65288;Sever Push&#65289;&#12290;&#36825;&#22312;&#23454;&#29616;
&#26576;&#20123;&#24212;&#29992;&#30340;&#26102;&#20505;&#23601;&#20250;&#36935;&#21040;&#40635;&#28902;&#12290;&#20363;&#22914;&#65306;
    + &#24403;&#37038;&#20214;&#26381;&#21153;&#22120;&#25910;&#21040;&#26032;&#30340;&#37038;&#20214;&#26102;&#65292;&#21450;&#26102;&#25253;&#21578;&#32473;&#29992;&#25143;&#65292;&#22914;&#26524;&#20182;&#22312;&#32447;&#30340;&#35805;&#65288;GMail &#36825;&#26679;&#20570;&#20102;&#65289;
    + &#24403; Web Chat &#26381;&#21153;&#22120;&#25910;&#21040;&#26032;&#30340;&#20449;&#24687;&#26102;&#65292;&#21450;&#26102;&#21457;&#36865;&#20449;&#24687;&#21040;&#30456;&#24212;&#30340;&#22312;&#32447;&#29992;&#25143;&#65288;Web Chat &#30340;&#22522;&#26412;&#38656;&#27714;&#65289;&#12290;
    + &#32842;&#22825;&#26102;&#25552;&#31034;&#20320;&#23545;&#26041;&#27491;&#22312;&#36755;&#20837;&#65288;&#26102;&#19979; IM &#23458;&#25143;&#31471;&#24456;&#26102;&#39654;&#30340;&#19968;&#20010;&#21151;&#33021;&#65289;&#12290;

Comet &#25216;&#26415;&#23545;&#26381;&#21153;&#31471;&#30340;&#35201;&#27714;&#36824;&#26159;&#24456;&#39640;&#30340;&#65292;Long Polling&#20943;&#23569;&#20102;&#32593;&#32476;&#27969;&#37327;&#65292;&#20294;&#26159;&#26381;&#21153;&#31471;&#30340;&#36830;
&#25509;&#25968;&#24182;&#27809;&#26377;&#20943;&#23569;&#12290;&#22240;&#27492;&#22522;&#20110; Comet &#30340;&#24212;&#29992;&#65292;&#24456;&#23481;&#26131;&#22312; Scale&#65288;&#20280;&#32553;&#24615;&#65289;&#19978;&#20986;&#29616;&#38382;&#39064;&#12290;&#20351;&#29992;
Erlang + MochiWeb&#65292;&#36824;&#26159;&#24456;&#22909;&#30340;&#21033;&#29992;&#20102; Erlang &#21487;&#20197;&#36731;&#26494;&#24314;&#31435;&#22823;&#37327;&#36830;&#25509;&#36825;&#20010;&#29305;&#24615;&#12290;&#38656;&#35201;&#25351;
&#20986;&#30340;&#26159;&#65292;&#24456;&#21487;&#33021; Comet &#24212;&#29992;&#30340;&#26102;&#39654;&#65292;&#23558;&#20250;&#24456;&#22823;&#31243;&#24230;&#19978;&#20419;&#36827;&#20102;&#19994;&#30028;&#23545; Erlang &#30340;&#20851;&#27880;&#12290;
<span class="org-level-1">* &#20195;&#30721;&#35762;&#35299;</span>
  index.html
<span class="org-block-begin-line">  #+begin_src javascript
</span><span class="org-block">      function get(){
              $.ajax({
                  type: "GET",
                  url: "chat",
                  cache:false,
                  success:getMsg
                });
      }
      function getMsg(data){
          $("#history").append(new Date().toLocaleString()+":"+data+"&lt;br/&gt;");
          get();
      }

</span><span class="org-block-end-line">  #+end_src
</span>  &#22312;index.html &#21152;&#36733;&#23436;&#27604;&#21518;&#65292;&#20250;&#20808;&#35843;&#29992;&#19968;&#27425;:
<span class="org-block-begin-line"> #+begin_src javascript
</span><span class="org-block"> get();
</span><span class="org-block-end-line"> #+end_src
</span> &#19978;&#38754;&#30340;&#20989;&#25968;&#26159;&#20197;GET&#26041;&#24335;&#21521;&#26381;&#21153;&#22120;&#31471;&#21457;&#36215;&#35831;&#27714;&#30340;&#20195;&#30721;&#65292;&#21487;&#20197;&#30475;&#20986;&#65292;&#22312;&#22238;&#35843;&#26041;&#27861;&#20013;&#65292;&#20877;&#27425;&#35843;
 &#29992;get() &#26041;&#27861;&#65292;&#21521;&#26381;&#21153;&#22120;&#31471;&#21457;&#36215;&#35831;&#27714;&#12290;&#36825;&#36319;&#37027;&#31181;&#27599;&#38548;&#19968;&#23450;&#26102;&#38388;&#21521;&#26381;&#21153;&#22120;&#31471;&#35831;&#27714;&#19968;&#27425;&#30475;&#26377;
 &#27809;&#26377;&#26032;&#30340;&#28040;&#24687;&#30340;&#26041;&#24335;&#23436;&#20840;&#19981;&#19968;&#26679;&#12290;
 &#22240;&#20026;&#36825;&#31181;&#20197;GET&#26041;&#24335;&#21457;&#36215;&#30340;&#35831;&#27714;&#65292;&#22312;&#26381;&#21153;&#22120;&#31471;&#26159;&#38459;&#22622;&#30340;&#65292;&#21363;&#30001;&#26381;&#21153;&#22120;&#31471;&#26469;&#25511;&#21046; &#65292;&#22914;&#26524;&#27809;
 &#26377;&#26032;&#30340;&#28040;&#24687;&#23601;&#19981;&#36820;&#22238;&#65288;&#36798;&#21040;&#36229;&#26102;&#26102;&#38388;&#38500;&#22806;&#65288;&#20195;&#30721;&#20013;&#35774;&#20026;20s&#65289;&#65289;&#12290;

<span class="org-block-begin-line"> #+begin_src javascript
</span><span class="org-block">      $('#send').click(
          function(){
              $.ajax({
                  type: "POST",
                  url: "chat",
                  cache:false,
                  data: "message="+$("#message").val(),
                  success: function(msg){
                      $("#status").empty(); // remove children
                      $("#status").append(new Date().toLocaleString()+":"+msg); // add child
                  }
              });
          }
      );
      });

</span><span class="org-block-end-line"> #+end_src
</span>&#28857;&#20987;&#21457;&#36865;&#25353;&#38062;&#30340;&#26102;&#20505;&#65292;&#20250;&#20197;POST&#26041;&#24335;,&#21521;&#26381;&#21153;&#22120;&#21457;&#36865;&#19968;&#26465;&#28040;&#24687;&#65292;
&#26381;&#21153;&#22120;&#22312;&#25509;&#21040;&#36825;&#26465;&#28040;&#24687;&#21518;,&#20250;&#36827;&#34892;&#22914;&#19979;&#22788;&#29702;:
<span class="org-block-begin-line">#+begin_src erlang
</span><span class="org-block">  Data = Req:parse_post(),
  Room = get_the_room(),
  % post
  io:format("message from post:~p~n",[proplists:get_value("message", Data)]) ,
  Room ! {self(), post, list_to_binary(proplists:get_value("message", Data))},
</span><span class="org-block-end-line">#+end_src
</span>&#26576;&#36827;&#31243;&#25509;&#21040;&#19978;&#38754;&#21457;&#36865;&#30340;&#28040;&#24687;&#20250;&#65292;&#20250;&#26597;&#30475;room &#20013;&#26377;&#21738;&#20123;&#29992;&#25143;&#22312;&#31561;&#24453;&#65292;
&#28982;&#21518;&#19968;&#19968;&#21462;&#20986;&#65292;&#23558;&#19978;&#38754;&#25509;&#25910;&#21040;&#30340;&#37027;&#26465;&#20449;&#24687;&#20998;&#21035;&#21457;&#36865;&#32473;&#20182;&#20204; &#65292;&#28982;&#21518;&#28165;&#31354;&#31561;&#24453;&#38431;&#21015;
&#37027;&#20123;&#20197;GET&#26041;&#24335;&#35831;&#27714;&#30340;&#23458;&#25143;&#31471;&#21040;&#27492;&#26102;&#25165;&#36820;&#22238;&#65288;&#22914;&#26524;&#27809;&#26377;&#36229;&#26102;&#30340;&#35805;&#12290;&#65289;
<span class="org-block-begin-line">#+begin_src erlang
</span><span class="org-block">        {From, post, Message} -&gt;
            From ! posted,
            lists:foreach(fun(User) -&gt;
                                                % broadcast the message
                                  User ! Message
                          end, Users),
            %% room(Users),
            %% &#25152;&#26377;&#31561;&#24453;&#30340;&#29992;&#25143;&#37117;&#20250;&#25509;&#25910;&#30340;&#28040;&#24687;&#65292;
            %% &#20174;&#38431;&#21015;&#20013;&#21435;&#25481;&#20182;&#20204;
            room([]),
            io:format("~n",[]) ;
        %% room([]);

</span><span class="org-block-end-line">#+end_src
</span></pre>
  </body>
</html>
